<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>...eppur si muove.</title>
		<script type = "text/javascript" src = "./external/threejs/Three.js"></script>
		<script type = "text/javascript" src = "./external/dat.gui.min.js"></script>
		<script type = "text/javascript" src = "./external/Stats.js"></script>
		
		<script type = "text/javascript" src = "./isaac_obj.js"></script>
		<script type = "text/javascript" src = "./isaac_planets.js"></script>
		<script type = "text/javascript" src = "./isaac_orbit_phys.js"></script>
		
		<style type = "text/css">
			body { 
			margin: 0px; 
			overflow: hidden;
			}
		</style>
	</head>
	<body>
		<div id="renderArea"></div>
		
		<script type = "text/javascript">
			// Three.js elements.
			var camera, scene, renderer;
			
			// Stats (for debugging)
			var stats;
			
			// Planets and their materials.
			var sunModel, earthModel, marsModel, mercuryModel;
			var jupiterModel, venusModel, neptuneModel, uranusModel, plutoModel, saturnModel;
			var sunMaterial, earthMaterial, marsMaterial, mercuryModel;
			var jupiterMaterial, venusMaterial, neptuneMaterial, uranusMaterial;
			var plutoMaterial, saturnMaterial;
			
		//	var Earth, Sun, Mars, Mercury, Neptune, Pluto, Jupiter, Uranus, Saturn, Venus;
			
			// Camera movement-related variables.
			var isMouseDown = false;
			var mouseLastX, mouseLastY;
			var cameraAngleX = 0;
			var cameraAngleY = 0;
			var cameraDist = 200;
			var origin = new THREE.Vector3(0, 0, 0);
			var cameraFocus = Sun;
			
			// Web Worker.
			var worker = new Worker('isaac_worker.js');
			
			init();
			
			function init() {
				// ------ GUI Initialisation ------ //
				var gui = new dat.GUI(
				{ width : 500 }
				);

				// Create the Camera folder.
				var cameraSettings = gui.addFolder("Camera");
				cameraSettings.add(window, 'cameraDist', 30, 750);
				cameraSettings.add(config, 'Camera Focus',
					{ 
						"Sun" : 0, 
						"Mercury" : 1, 
						"Venus" : 2,
						"Earth" : 3,
						"Mars" : 4,
						"Jupiter" : 5,
						"Saturn" : 6,
						"Uranus" : 7,
						"Neptune" : 8,
						"Pluto" : 9
					});
				
				// Create the Simulation Settings folder.
				var simSettings = gui.addFolder("Simulation Settings");
				simSettings.add(config, 'Update Step', 
					{ "One Day" : 1, "One Week" : 7, "One Month" : 30, "Three Months" : 90 });
				simSettings.add(config, 'Gravitational Constant Multiplier', 0.1, 10);
				
				// Create the Orbital Bodies folder.
				var planetsFolder = gui.addFolder("Orbital Bodies");
				
				// Create the Sun's folder.
				var sunFolder = planetsFolder.addFolder("Sun");
				sunFolder.add(Sun.config, 'Mass Multiplier', 0.1, 100);
				
				// Create Mercury's folder.
				var mercuryFolder = planetsFolder.addFolder("Mercury");
				mercuryFolder.add(Mercury.config, 'Mass Multiplier', 0.1, 100);
				
				// Create Venus' folder.
				var venusFolder = planetsFolder.addFolder("Venus");
				venusFolder.add(Venus.config, 'Mass Multiplier', 0.1, 100);
				
				// Create Earth's folder.
				var earthFolder = planetsFolder.addFolder("Earth");
				earthFolder.add(Earth.config, 'Mass Multiplier', 0.1, 100);
				
				// Create Mars' folder.
				var marsFolder = planetsFolder.addFolder("Mars");
				marsFolder.add(Mars.config, 'Mass Multiplier', 0.1, 100);
				
				// Create Jupiter's folder.
				var jupiterFolder = planetsFolder.addFolder("Jupiter");
				jupiterFolder.add(Jupiter.config, 'Mass Multiplier', 0.1, 100);
				
				// Create Saturn's folder.
				var saturnFolder = planetsFolder.addFolder("Saturn");
				saturnFolder.add(Saturn.config, 'Mass Multiplier', 0.1, 100);
				
				// Create Uranus' folder.
				var uranusFolder = planetsFolder.addFolder("Uranus");
				uranusFolder.add(Uranus.config, 'Mass Multiplier', 0.1, 100);
				
				// Create Neptune's folder.
				var neptuneFolder = planetsFolder.addFolder("Neptune");
				neptuneFolder.add(Neptune.config, 'Mass Multiplier', 0.1, 100);				
				
				// Create Pluto's folder.
				var plutoFolder = planetsFolder.addFolder("Pluto");
				plutoFolder.add(Pluto.config, 'Mass Multiplier', 0.1, 100);
				
				// ------ End of GUI Initialisation ------ //
				
				// ------ FPS Counter (for debug only) ------ //
				stats = new Stats();
				stats.getDomElement().style.position = 'absolute';
				stats.getDomElement().style.left = '0px';
				stats.getDomElement().style.top = '0px';
				
				document.body.appendChild( stats.getDomElement() );
				
				setInterval( function () { stats.update(); }, 1000 / 60 );
				// ------ End of FPS Counter ------ //
				
				// Get the renderArea.
				var renderArea = document.getElementById('renderArea');
				
				// Setup the camera and scene.
				camera = new THREE.PerspectiveCamera(90, window.innerWidth/window.innerHeight, 1, 10000);
				camera.position.x = cameraDist;
				camera.lookAt(origin);
				scene = new THREE.Scene();
				scene.add(camera);
				
				// Setup the renderer.
				renderer = new THREE.CanvasRenderer();
				renderer.setSize(window.innerWidth, window.innerHeight);
				renderArea.appendChild(renderer.domElement);
				renderer.setClearColorHex(0x000000, 1.0);
				renderer.clear();
				
				// Create the Sun.
				sunMaterial = new THREE.MeshBasicMaterial( { color: 0xFF8C00 } );
				sunModel = new THREE.Mesh(new THREE.SphereGeometry(10, 16, 16), sunMaterial);
				
				// Create the Earth.
				earthMaterial = new THREE.MeshBasicMaterial( { color: 0x458B00 } );
				earthModel = new THREE.Mesh(new THREE.SphereGeometry(2, 16, 16), earthMaterial);
				
				// Create Mars.
				marsMaterial = new THREE.MeshBasicMaterial( { color: 0xFF0000 });
				marsModel = new THREE.Mesh(new THREE.SphereGeometry(3, 16, 16), marsMaterial);
				
				// Create Mercury.
				mercuryMaterial = new THREE.MeshBasicMaterial( { color: 0xFFD700 });
				mercuryModel = new THREE.Mesh(new THREE.SphereGeometry(1, 8, 8), mercuryMaterial);
				
				// Create Jupiter.
				jupiterMaterial = new THREE.MeshBasicMaterial( {color: 0xFF4500 });
				jupiterModel = new THREE.Mesh(new THREE.SphereGeometry(5, 16, 16), jupiterMaterial);
				
				// Create Venus.
				venusMaterial = new THREE.MeshBasicMaterial( {color: 0xCFCC98 });
				venusModel = new THREE.Mesh(new THREE.SphereGeometry(2, 16, 16), venusMaterial);
				
				// Create Neptune.
				neptuneMaterial = new THREE.MeshBasicMaterial( {color: 0x4A73BE });
				neptuneModel = new THREE.Mesh(new THREE.SphereGeometry(3, 16, 16), venusMaterial);
				
				// Create Uranus.
				uranusMaterial = new THREE.MeshBasicMaterial( {color: 0x97D5D9 });
				uranusModel = new THREE.Mesh(new THREE.SphereGeometry(3, 16, 16), venusMaterial);
				
				// Create Pluto.
				plutoMaterial = new THREE.MeshBasicMaterial( {color: 0xD4D4D4 });
				plutoModel = new THREE.Mesh(new THREE.SphereGeometry(1, 8, 8), venusMaterial);
				
				// Create Saturn.
				saturnMaterial = new THREE.MeshBasicMaterial( {color: 0xCDC332 });
				saturnModel = new THREE.Mesh(new THREE.SphereGeometry(4, 16, 16), saturnMaterial);
				
				// Add everything to the scene.
				scene.add(sunModel);
				scene.add(earthModel);
				scene.add(marsModel);
				scene.add(mercuryModel);
				scene.add(jupiterModel);
				scene.add(neptuneModel);
				scene.add(venusModel);
				scene.add(saturnModel);
				scene.add(plutoModel);
				
				// Render.
				renderer.render(scene, camera);
				
				// Add hooks for mouse events, to move the camera around.
				document.addEventListener('mousedown', onDocumentMouseDown, false);
				document.addEventListener('mouseup', onDocumentMouseUp, false);
				document.addEventListener('mousemove', onDocumentMouseMove, false);
				
				// Start the worker.
				worker.addEventListener('message', function (e) {
					var data = e.data.response;
					if(typeof data !== 'undefined') {
						Earth.motion.position = data.earthPos;
						Sun.motion.position = data.sunPos;
						Mars.motion.position = data.marsPos;
						Jupiter.motion.position = data.jupiterPos;
						Neptune.motion.position = data.neptunePos;
						Venus.motion.position = data.venusPos;
						Uranus.motion.position = data.uranusPos;
						Saturn.motion.position = data.saturnPos;
						Pluto.motion.position = data.plutoPos;
						Mercury.motion.position = data.mercuryPos;
					}
				}, false);
			}
			
			function animUpdate() {
				// Ping the worker to get updated positions.
				worker.postMessage({'command' : 'get'});
				
				// Update the graphical representations of the objects.
				objUpdate(Earth, earthModel);
				objUpdate(Mars, marsModel);
				objUpdate(Sun, sunModel);
				objUpdate(Mercury, mercuryModel);
				objUpdate(Jupiter, jupiterModel);
				objUpdate(Neptune, neptuneModel);
				objUpdate(Venus, venusModel);
				objUpdate(Uranus, uranusModel);
				objUpdate(Saturn, saturnModel);
				objUpdate(Pluto, plutoModel);

				// Update the camera's position.
				// Get the planet to centre the camera on.

				switch(config['Camera Focus']){
					case "0": cameraFocus = Sun; break;
					case "1": cameraFocus = Mercury; break;
					case "2": cameraFocus = Venus; break;
					case "3": cameraFocus = Earth; break;
					case "4": cameraFocus = Mars; break;
					case "5": cameraFocus = Jupiter; break;
					case "6": cameraFocus = Saturn; break;
					case "7": cameraFocus = Uranus; break;
					case "8": cameraFocus = Neptune; break;
					case "9": cameraFocus = Pluto; break;					
				}
				// Adjust the camera (horizontal).
				camera.position.x = cameraFocus.motion.position[0] + cameraDist * Math.cos(cameraAngleX * Math.PI / 360);
				camera.position.z = cameraFocus.motion.position[1] + cameraDist * Math.sin(cameraAngleX * Math.PI / 360);
				
				// Adjust the camera (vertical).
				camera.position.y = cameraFocus.motion.position[2] + cameraDist * Math.sin(cameraAngleY * Math.PI / 360);
				camera.position.x *= Math.cos(cameraAngleY * Math.PI / 360);
				camera.position.z *= Math.cos(cameraAngleY * Math.PI / 360);
				camera.lookAt(new THREE.Vector3(cameraFocus.motion.position[0], cameraFocus.motion.position[2], cameraFocus.motion.position[1]));
				// Setup continuous updates.
				window.requestAnimationFrame(animUpdate, renderer.domElement);
				
				// Render!
				renderer.render(scene, camera);
			}
			
			animUpdate();
			
			function objUpdate(object, model) {
				model.position.x = object.motion.position[0];
				model.position.y = object.motion.position[2];
				model.position.z = object.motion.position[1];
			}
			
			// Handles mousedown events.
			function onDocumentMouseDown(event) {
				var element;
				// Check if the mouse is over the canvas.
				if(event.srcElement) {
					// IE-specific (though apparently Chrome too?)
					element = event.srcElement.nodeName;
					} else if(event.target) {
					// Everyone else.
					element = event.target.nodeName;
				}
				
				if(element === 'CANVAS') {
					isMouseDown = true;
				}				
			}
			
			// Handles mouseup events.
			function onDocumentMouseUp(event) {
				isMouseDown = false;
				
				// Send updated settings to the worker.
				worker.postMessage({
					'command' : 'set', 
					'config' : config, 
					'earthConfig' : Earth.config,
					'sunConfig' : Sun.config,
					'mercuryConfig' : Mercury.config,
					'venusConfig' : Venus.config,
					'neptuneConfig' : Neptune.config,
					'marsConfig' : Mars.config,
					'jupiterConfig' : Jupiter.config,
					'uranusConfig': Neptune.config,
					'saturnConfig' : Saturn.config,
					'plutoConfig' : Pluto.config});
			}
			
			// Handles mousemove events. Used to move the camera.
			function onDocumentMouseMove(event) {
				// Check if the mouse button is down.
				if(isMouseDown) {
					// Get the position of the mouse.
					var mouseX = event.clientX;
					var mouseY = event.clientY;
					
					// Get the delta of the mouse's position.
					var mouseXDelta = event.clientX - mouseLastX;
					var mouseYDelta = event.clientY - mouseLastY;
					
					// Add the corresponding rotation to the camera angle.
					cameraAngleX += mouseXDelta;
					
					// Restrict camera panning to 90 degrees up or down.
					if(cameraAngleY > 175) {
						cameraAngleY = 175;
					} else if(cameraAngleY < -175) {
						cameraAngleY = -175;
					} else {
						cameraAngleY += mouseYDelta;
					}
					//console.log(cameraAngleX + " " + cameraAngleY);
				} 
				mouseLastX = event.clientX;
				mouseLastY = event.clientY;
			}
		</script>
	</body>
</html>
