<!DOCTYPE html>
<html>
	<title>...eppur si muove.</title>
	<head>
		<script type = "text/javascript" src = "./external/threejs/Three.js"></script>
		<script type = "text/javascript" src = "./external/dat.gui.min.js"></script>
		<script type = "text/javascript" src = "./external/Stats.js"></script>
		
		<script type = "text/javascript" src = "isaac_math.js"></script>
		<script type = "text/javascript" src = "isaac_obj.js"></script>
		<script type = "text/javascript" src = "isaac_core.js"></script>
		<script type = "text/javascript" src = "isaac_orbit_phys.js"></script>
		<style type = "text/css">
			body { 
			margin: 0px; 
			overflow: hidden;
			}
		</style>
	</head>
	<body>
		<div id="renderArea"></div>
		
		<script type = "text/javascript">
			// Three.js elements.
			var camera, scene, renderer;
			
			// Stats (for debugging)
			var stats;
			
			// Planets and their materials.
			var sunModel, earthModel;
			var sunMaterial, earthMaterial;
			
			// Camera movement-related variables.
			var isMouseDown = false;
			var mouseLastX, mouseLastY;
			var cameraAngleX = 0;
			var cameraAngleY = 0;
			var cameraDist = 400;
			
			init();
			
			function init() {
				// ------ GUI Initialisation ------ //
				var gui = new dat.GUI(
				{ width : 500 }
				);
				
				// Create the Simulation Settings folder.
				var simSettings = gui.addFolder("Simulation Settings");
				simSettings.add(config, 'Update Step', 10, 100);
				simSettings.add(config, 'Gravitational Constant Multiplier', 0.1, 10);
				
				// Create the Sun's folder.
				var sunFolder = gui.addFolder("Sun");
				sunFolder.add(Sun.config, 'Mass Multiplier', 0.1, 100);
				
				// Create Earth's folder.
				var earthFolder = gui.addFolder("Earth");
				earthFolder.add(Earth.config, 'Mass Multiplier', 0.1, 100);
				
				// ------ End of GUI Initialisation ------ //
				
				// ------ FPS Counter (for debug only) ------ //
				stats = new Stats();
				stats.getDomElement().style.position = 'absolute';
				stats.getDomElement().style.left = '0px';
				stats.getDomElement().style.top = '0px';
				
				document.body.appendChild( stats.getDomElement() );
				
				setInterval( function () { stats.update(); }, 1000 / 60 );
				// ------ End of FPS Counter ------ //
				
				// Get the renderArea.
				var renderArea = document.getElementById('renderArea');
				
				// Setup the camera and scene.
				camera = new THREE.PerspectiveCamera(90, window.innerWidth/window.innerHeight, 1, 10000);
				camera.position.z = 400;
				scene = new THREE.Scene();
				scene.add(camera);
				
				// Setup the renderer.
				renderer = new THREE.CanvasRenderer();
				renderer.setSize(window.innerWidth, window.innerHeight);
				renderArea.appendChild(renderer.domElement);
				renderer.setClearColorHex(0xEEEEEE, 1.0);
				renderer.clear();
				
				// Create the Sun.
				sunMaterial = new THREE.MeshLambertMaterial( { color: 0xCC0000 } );
				sunModel = new THREE.Mesh(new THREE.SphereGeometry(50, 16, 16), sunMaterial);
				
				// Create the Earth.
				earthMaterial = new THREE.MeshLambertMaterial( { color: 0x458B00 } );
				earthModel = new THREE.Mesh( new THREE.SphereGeometry(25, 16, 16), earthMaterial);
				earthModel.position.z = 149.598261;
				
				// Add everything to the scene.
				scene.add(sunModel);
				scene.add(earthModel);
				
				// Add hooks for mouse events, to move the camera around.
				document.addEventListener('mousedown', onDocumentMouseDown, false);
				document.addEventListener('mouseup', onDocumentMouseUp, false);
				document.addEventListener('mousemove', onDocumentMouseMove, false);
				
				// Render.
				renderer.render(scene, camera);
			}
			
			function animUpdate() {
				// Update the objects in the physics layer.
				update();
				
				// Update the graphical representations of the objects.
				objUpdate(Earth, earthModel);
				
				// Setup continuous updates.
				window.requestAnimationFrame(animUpdate, renderer.domElement);
				
				// Render!
				renderer.render(scene, camera);
			}
			
			animUpdate();
			
			function objUpdate(object, model) {
				model.position.x = object.motion.position[0];
				model.position.y = object.motion.position[2];
				model.position.z = object.motion.position[1];
			}
			
			// Handles mousedown events.
			function onDocumentMouseDown(event) {
				var element;
				// Check if the mouse is over the canvas.
				if(event.srcElement) {
					// IE-specific (though apparently Chrome too?)
					element = event.srcElement.nodeName;
					} else if(event.target) {
					// Everyone else.
					element = event.target.nodeName;
				}
				
				if(element === 'CANVAS') {
					isMouseDown = true;
				}				
			}
			
			// Handles mouseup events.
			function onDocumentMouseUp(event) {
				isMouseDown = false;
			}
			
			// Handles mousemove events. Used to move the camera.
			function onDocumentMouseMove(event) {
				// Check if the mouse button is down.
				if(isMouseDown) {
					// Get the position of the mouse.
					var mouseX = event.clientX;
					var mouseY = event.clientY;
					
					// Get the delta of the mouse's position.
					var mouseXDelta = event.clientX - mouseLastX;
					var mouseYDelta = event.clientY - mouseLastY;
					
					// Add the corresponding rotation to the camera angle.
					cameraAngleX += mouseXDelta;
					cameraAngleY += mouseYDelta;
					
					// Adjust the camera (horizontal).
					camera.position.x = cameraDist * Math.cos(cameraAngleX * Math.PI / 360);
					camera.position.z = cameraDist * Math.sin(cameraAngleX * Math.PI / 360);
					
					// Adjust the camera (vertical).
					camera.position.y = cameraDist * Math.sin(cameraAngleY * Math.PI / 360);
					//camera.position.x = cameraDist * Math.cos(cameraAngleY * Math.PI / 360);
				//	camera.position.z = cameraDist * Math.cos(cameraAngleY * Math.PI / 360);
					camera.lookAt(new THREE.Vector3(0, 0, 0));
				} 
				mouseLastX = event.clientX;
				mouseLastY = event.clientY;
			}			

		</script>
	</body>
</html>